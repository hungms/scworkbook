{"title":"Doublet Detection","markdown":{"yaml":{"title":"Doublet Detection","author":[{"name":"Matthew Hung"}],"date":"last-modified","date-format":"iso","format":{"html":{"toc":true,"toc-expand":1,"number-sections":true,"number-offset":3}}},"headingText":"Motivation","headingAttr":{"id":"","classes":["unnumbered"],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n\n\nSimilar to flow cytometry, a common issue with droplet-based single cell sequencing is the capture of multiple cells in a single droplet. The rate of doublet formation depends on the sequencing platform and the number of cells loaded. Below is a reference of doublet detection rate depending on no. of cells loaded during single-cell sequencing with the 10X chromium platform.\n\n![10x Sequencing Doublet Detection Rate](https://kb.10xgenomics.com/hc/article_attachments/360086768291)\n\nRemoving doublets is an important step in single-cell analysis to prevent false-positive findings. In the previous chapter, cell multiplexing with hashtag oligo is an effective method to identify and remove <b>homolytic and heterolytic</b> \"Doublets\", however this requires sequencing of hashtag library which could be costly.\n\nTo overcome this issue there currently exists a few methods to identify \"Doublets\" based on mRNA expression, including DoubletFinder [[McGinnis et al.; 2019]](https://www.sciencedirect.com/science/article/pii/S2405471219300730?via%3Dihub), scDblFinder [[Germain et al, 2022]](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9204188/), Scrublet [[Wolock et al.; 2019]](https://www.sciencedirect.com/science/article/pii/S2405471218304745) etc. Many of these algorithms require users to process and cluster the cells prior to doublet prediction, as the identification process typically involves comparing the expressions from each cell to the pseudobulk expression profile of each cluster. These algorithms are effective in predicting <b>heterolytic</b> doublets, as detection works best when the pseudobulk profiles of the clusters are massively different. The pitfall, however, is that when you have a homogenous samples (i.e. FACS-sorted B-/Plasma cells) comprised of <b>homolytic</b> doublets, these detection algorithms may not generate accurate doublet predictions as the pseudobulk profiles of each cluster are similar.\n\n> In our case, our data consist of innate and adaptive immune cells where gene expressions of the major lineages are very different. We will therefore predict doublets using DoubletFinder and scDblFinder to see if it provides addition benefit to remove potential heterolytic doublets. Refering to the table above, each of the samples have ~8k cells captured, therefore doublet rate is 6.4%.\n\n## Calculate Gene Fractions {#sec-calculate_gene_fractions}\n  \nThe function below will perform the calculations of key quality control parameters for every cell but will not filter any cells yet. This is done by calculating the no. of selected reads over the no. of total reads for every cell.\n\n## Preprocessing\nAs mentioned above, we will begin by processing these 2 sequencing runs by merging the seurat objects together and define cell clusters prior to doublet detection.\n\nThe wrapper function below will perform library normalization (log1p), feature selection, scaling, principal component analysis (PCA), batch-correction with Harmony (optional), Louvain clustering (res = 0.4) and UMAP projection.\n\n## scDblFinder\nWe will first perform doublet detection with scDblFinder with the wrapper function below. The function will convert Seurat to SingleCellExperiment (SCE) object, run scDblFinder pipeline, and return a Seurat object with scDblFinder outputs stored in Seurat metadata. User can also specify cell demultiplexing results in the \\<truth\\> argument where the function will input \"Singlet\" and \"Doublet\" cells solely for doublet detection.\n\n:::{.callout-warning}\nIn the case where only certain samples have cell multiplex libraries, users will need to set any \"NA\" values to \"Singlets\" for the wrapper function to run properly.\n:::\n\n> In the run_scdblfinder() function, we specified cluster labels (\"seurat_clusters\"), sequencing runs (\"samples\"), doublet detection rate of 6.4% (dbr) and truth (\"MULTI.global\"). \n\nBelow we visualize the outputs of scDblFinder with MULTIseqDemux cell demultiplexing outputs and known characteristics of doublets (high nCount_RNA/HTO).\n\n> Compare to the cell demultiplexing outputs, scDblFinder detects and extra 926 doublets based on transcriptomic profile.\n\n> scDblFinder found 7.2% doublets (1139 cells) across the 2 sequencing runs.\n\nVisualizing quality control parameters for singlets and doublets detected by scDblFinder.\n\n> Doublets detected have higher nFeature_RNA & nCount_RNA than singlets, reflecting the nature of true doublets.\n\n## DoubletFinder\nContinuing from scDblFinder, we will split the merged Seurat object into a list of objects by sequencing runs in order to perform the DoubletFinder pipeline. In DoubletFinder, an optional argument available is take into consideration of the cell demultiplexing outputs during doublet detection and adjust for the no. of extra heterolytic doublets detected. This can be specified in the argument \\<truth\\> in the wrapper function below. The wrapper function will estimate an optimal pK value that is less than 0.1 (see [https://github.com/chris-mcginnis-ucsf/DoubletFinder/issues/62](https://github.com/chris-mcginnis-ucsf/DoubletFinder/issues/62)) to perform doublet detection.\n\n> In the run_doubletfinder() function, we specified cluster labels (\"seurat_clusters\"), cell demultiplexing output (\"MUTLI.global\"), no. of PC used (1:10) and doublet detection rate of 6.4% (dbr). \n\nBelow we visualize the outputs of DoubletFinder with MULTIseqDemux cell demultiplexing outputs and known characteristics of doublets (high nCount_RNA/HTO).\n\n> Compare to the cell demultiplexing outputs, DoubletFinder detects and extra 745 doublets based on transcriptomic profile.\n\n> DoubletFinder found 5.6% doublets (880 cells) across the 2 sequencing runs.\n\nVisualizing quality control parameters for singlets and doublets detected by DoubletFinder.\n\n> Similar to scDblFinder, doublets detected in DoubletFinder have higher nFeature_RNA & nCount_RNA than singlets, reflecting the nature of true doublets.\n\n## T/B-cell Doublets\nT/B-cells represent the most abundant of immune cell populations and have a high chance to be sequenced together as doublets. T and B-cells can be characterized by TCR-VDJ and BCR-VDJ gene expression respectively, the TCR/BCR expressions are mutually exclusive. Therefore T/B-cell doublets can be manually identified and removed if the TCR/BCR fraction is high.\n\n> Judging from the plot above, we have called T/B-cell doublets if TCR fraction is > 0.05% and BCR > 5%\n\n## Evaluating Outputs\nscDblFinder and DoubletFinder are both able to predict heterolytic doublets with characteristics reflective of true doublet nature. From the UMAP projections below, you can see the outputs from the 2 algorithms are highly consistent with each other.\n\n> The small cluster of cells circled on the UMAP below are highly likely to be real doublets given the cell number, which is only detected by DoubletFinder and not scDblFinder. Therefore, for the following chapters, we will continue using outputs from DoubletFinder.\n\n~1/3 of the doublets detected by either algorithms are consistent.\n\n## Session Info {.unnumbered}\n","srcMarkdownNoYaml":"\n\n## Motivation {.unnumbered}\n\n\nSimilar to flow cytometry, a common issue with droplet-based single cell sequencing is the capture of multiple cells in a single droplet. The rate of doublet formation depends on the sequencing platform and the number of cells loaded. Below is a reference of doublet detection rate depending on no. of cells loaded during single-cell sequencing with the 10X chromium platform.\n\n![10x Sequencing Doublet Detection Rate](https://kb.10xgenomics.com/hc/article_attachments/360086768291)\n\nRemoving doublets is an important step in single-cell analysis to prevent false-positive findings. In the previous chapter, cell multiplexing with hashtag oligo is an effective method to identify and remove <b>homolytic and heterolytic</b> \"Doublets\", however this requires sequencing of hashtag library which could be costly.\n\nTo overcome this issue there currently exists a few methods to identify \"Doublets\" based on mRNA expression, including DoubletFinder [[McGinnis et al.; 2019]](https://www.sciencedirect.com/science/article/pii/S2405471219300730?via%3Dihub), scDblFinder [[Germain et al, 2022]](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9204188/), Scrublet [[Wolock et al.; 2019]](https://www.sciencedirect.com/science/article/pii/S2405471218304745) etc. Many of these algorithms require users to process and cluster the cells prior to doublet prediction, as the identification process typically involves comparing the expressions from each cell to the pseudobulk expression profile of each cluster. These algorithms are effective in predicting <b>heterolytic</b> doublets, as detection works best when the pseudobulk profiles of the clusters are massively different. The pitfall, however, is that when you have a homogenous samples (i.e. FACS-sorted B-/Plasma cells) comprised of <b>homolytic</b> doublets, these detection algorithms may not generate accurate doublet predictions as the pseudobulk profiles of each cluster are similar.\n\n> In our case, our data consist of innate and adaptive immune cells where gene expressions of the major lineages are very different. We will therefore predict doublets using DoubletFinder and scDblFinder to see if it provides addition benefit to remove potential heterolytic doublets. Refering to the table above, each of the samples have ~8k cells captured, therefore doublet rate is 6.4%.\n\n## Calculate Gene Fractions {#sec-calculate_gene_fractions}\n  \nThe function below will perform the calculations of key quality control parameters for every cell but will not filter any cells yet. This is done by calculating the no. of selected reads over the no. of total reads for every cell.\n\n## Preprocessing\nAs mentioned above, we will begin by processing these 2 sequencing runs by merging the seurat objects together and define cell clusters prior to doublet detection.\n\nThe wrapper function below will perform library normalization (log1p), feature selection, scaling, principal component analysis (PCA), batch-correction with Harmony (optional), Louvain clustering (res = 0.4) and UMAP projection.\n\n## scDblFinder\nWe will first perform doublet detection with scDblFinder with the wrapper function below. The function will convert Seurat to SingleCellExperiment (SCE) object, run scDblFinder pipeline, and return a Seurat object with scDblFinder outputs stored in Seurat metadata. User can also specify cell demultiplexing results in the \\<truth\\> argument where the function will input \"Singlet\" and \"Doublet\" cells solely for doublet detection.\n\n:::{.callout-warning}\nIn the case where only certain samples have cell multiplex libraries, users will need to set any \"NA\" values to \"Singlets\" for the wrapper function to run properly.\n:::\n\n> In the run_scdblfinder() function, we specified cluster labels (\"seurat_clusters\"), sequencing runs (\"samples\"), doublet detection rate of 6.4% (dbr) and truth (\"MULTI.global\"). \n\nBelow we visualize the outputs of scDblFinder with MULTIseqDemux cell demultiplexing outputs and known characteristics of doublets (high nCount_RNA/HTO).\n\n> Compare to the cell demultiplexing outputs, scDblFinder detects and extra 926 doublets based on transcriptomic profile.\n\n> scDblFinder found 7.2% doublets (1139 cells) across the 2 sequencing runs.\n\nVisualizing quality control parameters for singlets and doublets detected by scDblFinder.\n\n> Doublets detected have higher nFeature_RNA & nCount_RNA than singlets, reflecting the nature of true doublets.\n\n## DoubletFinder\nContinuing from scDblFinder, we will split the merged Seurat object into a list of objects by sequencing runs in order to perform the DoubletFinder pipeline. In DoubletFinder, an optional argument available is take into consideration of the cell demultiplexing outputs during doublet detection and adjust for the no. of extra heterolytic doublets detected. This can be specified in the argument \\<truth\\> in the wrapper function below. The wrapper function will estimate an optimal pK value that is less than 0.1 (see [https://github.com/chris-mcginnis-ucsf/DoubletFinder/issues/62](https://github.com/chris-mcginnis-ucsf/DoubletFinder/issues/62)) to perform doublet detection.\n\n> In the run_doubletfinder() function, we specified cluster labels (\"seurat_clusters\"), cell demultiplexing output (\"MUTLI.global\"), no. of PC used (1:10) and doublet detection rate of 6.4% (dbr). \n\nBelow we visualize the outputs of DoubletFinder with MULTIseqDemux cell demultiplexing outputs and known characteristics of doublets (high nCount_RNA/HTO).\n\n> Compare to the cell demultiplexing outputs, DoubletFinder detects and extra 745 doublets based on transcriptomic profile.\n\n> DoubletFinder found 5.6% doublets (880 cells) across the 2 sequencing runs.\n\nVisualizing quality control parameters for singlets and doublets detected by DoubletFinder.\n\n> Similar to scDblFinder, doublets detected in DoubletFinder have higher nFeature_RNA & nCount_RNA than singlets, reflecting the nature of true doublets.\n\n## T/B-cell Doublets\nT/B-cells represent the most abundant of immune cell populations and have a high chance to be sequenced together as doublets. T and B-cells can be characterized by TCR-VDJ and BCR-VDJ gene expression respectively, the TCR/BCR expressions are mutually exclusive. Therefore T/B-cell doublets can be manually identified and removed if the TCR/BCR fraction is high.\n\n> Judging from the plot above, we have called T/B-cell doublets if TCR fraction is > 0.05% and BCR > 5%\n\n## Evaluating Outputs\nscDblFinder and DoubletFinder are both able to predict heterolytic doublets with characteristics reflective of true doublet nature. From the UMAP projections below, you can see the outputs from the 2 algorithms are highly consistent with each other.\n\n> The small cluster of cells circled on the UMAP below are highly likely to be real doublets given the cell number, which is only detected by DoubletFinder and not scDblFinder. Therefore, for the following chapters, we will continue using outputs from DoubletFinder.\n\n~1/3 of the doublets detected by either algorithms are consistent.\n\n## Session Info {.unnumbered}\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"jupyter"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"number-sections":true,"number-offset":3,"output-file":"1.4_doublets.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.549","theme":["flatly"],"grid":{"sidebar-width":"350px","body-width":"1000px","margin-width":"400px","gutter-width":"1.5rem"},"monobackgroundcolor":"#f3f3f3","title":"Doublet Detection","author":[{"name":"Matthew Hung"}],"date":"last-modified","date-format":"iso","toc-expand":1},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}